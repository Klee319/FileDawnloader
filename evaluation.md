# Claude Code: 自律ブラウザ検証・レビュー運用プロンプト（汎用テンプレ）
*(Chrome操作 + Chrome DevTools MCP を併用 / テスト内容はプロダクトごとにClaudeが作成)*

このMarkdownは、Claude Codeに貼り付けて使う「**完了条件（DoD）＋検証手順＋安全な自動探索のルール**」テンプレです。  
目的は「**UIの乱れ・ボタン無反応・コンソールエラー残存**などがあっても完了報告される」問題を、**機械的な検証ゲート**で潰すことです。

---

## 0. 前提
- **本番環境では実行しない。** 可能ならステージング / ローカル / テスト用アカウントで行う。
- **ブラウザ操作は Chrome（Playwright or Browser操作MCP）を使用**し、失敗時・原因解析は **Chrome DevTools MCP** を使う。
- テストは **プロダクトごとにClaudeが作成**（ただし下記のルールを必ず守る）。
- すべての「完了」は、**証拠（ログ/レポート/スクショ/トレース）**を伴う。証拠なしの完了報告は禁止。

---

## 1. 成果物（必須）
Claudeは作業完了時に、必ず以下を出力する：
1. **実行した検証コマンド一覧**（build/lint/unit/e2e）
2. **E2Eテストの要約**（何を検証し、何がパスしたか）
3. **Console / pageerror / Network(4xx/5xx) のサマリ**（件数と代表例、0件なら0と明記）
4. **失敗時の原因推定と修正案**（DevToolsの根拠つき）
5. **添付物**（Playwright report / trace / スクショ差分など）

---

## 2. Definition of Done（完了条件）
以下すべてを満たしたときのみ「完了」と言ってよい。

### 2.1 ビルド＆静的検証
- `lint` が成功（重大ルール違反なし）
- `typecheck` が成功（ある場合）
- `build` が成功

### 2.2 E2E（自動ブラウザ検証）
- 主要導線（例：トップ→ログイン→主要機能→保存/送信→結果表示）が **E2Eで成功**
- **クリック・入力・送信**を最低1回以上含む
- 失敗時は **原因を特定し、修正して再実行**する

### 2.3 ランタイム健全性（致命的な不具合の封じ込め）
- **Console error = 0（新規0）**
- **pageerror = 0（新規0）**
- **Network 4xx/5xx = 原則0**
  - 例外（認証失敗など）を許容する場合は、**許可リストに明記**して根拠を示すこと

### 2.4 見た目（可能なら）
- 重要ページで **スクショ差分（visual regression）** を実施し、許容範囲内
  - 初回は `--update-snapshots` を使って基準を作る

---

## 3. ワークフロー（必ずこの順で進める）
1. **テスト計画を作る**（プロダクトに合わせて：主要ページ、主要操作、想定エラー）
2. **E2Eを書く**（最低限：表示、クリック、入力、送信、期待結果）
3. **安全な自動探索（副作用抑制）**で「押せるのに押せない」「UI崩れ」「リンク不備」を発見する
4. **失敗したら DevTools MCP で原因回収**（Console/Network/StackTrace/Layout）
5. 修正→再テスト→証拠を揃えて完了報告

---

## 4. 安全な自動探索（副作用がない範囲で賢く）
目的：テストケースに書ききれない **「押せないボタン」「死んだリンク」「UI被り」「JS例外」**を、*副作用を最小化*して炙り出す。

### 4.1 自動探索の基本方針
- **探索は「読み取り中心」**（DOM/アクセシビリティツリー/可視要素）で行い、操作は厳選する
- 操作は **“安全度”の高いものから**段階的に
- 操作回数・遷移回数は上限を設ける（例：クリック最大10、遷移最大5）
- 各操作の前後で **（1）URL（2）可視要素（3）Console/Network** を記録する
- 破壊的操作の可能性があるものは **絶対にクリックしない**（後述）

### 4.2 クリック対象のスコアリング（安全度分類）
探索対象（ボタン/リンク/要素）を以下で分類し、**Low → Medium → High** の順に触る。

#### Low（基本OK）
- タブ切替 / アコーディオン / モーダル開閉 / ドロップダウン展開
- `href` が同一オリジンで GET遷移のみ（クエリ含むのはOK）
- “詳細/もっと見る/開く/次へ/戻る” 系
- `role=button/link` で `disabled=false`

#### Medium（条件付き）
- フォーム入力を伴うが **送信はしない**
- 画面内のフィルタ・検索（Enter送信しない、ボタン送信しない）
- ページ内スクロールやページネーション（GET遷移）

#### High（原則禁止。明示許可がある場合のみ）
- “保存/送信/購入/削除/退会/決済/確定/登録/投稿/公開/実行” などの文言を含む
- `type=submit` / `form` に紐づく送信ボタン
- 外部ドメイン遷移
- ダウンロード/アップロード
- 管理者操作、権限変更、データ破壊

### 4.3 破壊的操作の判定ルール（禁止リスト）
以下に該当する要素は **クリック禁止**。要素のアクセシブルネーム、近傍テキスト、aria-label、title等を見て判定する。

- キーワード例（日本語/英語）  
  - 削除/Delete, 破棄/Discard, 退会/Deactivate, 購入/Buy, 決済/Pay, 送信/Submit, 保存/Save, 登録/Register, 確定/Confirm, 実行/Run, 公開/Publish, 投稿/Post, 取り消し不可/irreversible
- `type=submit` または `form` submit に紐づく
- “最終確認”“この操作は取り消せません” の警告が出る導線

### 4.4 副作用をさらに抑える「技術的セーフティ」
可能なら以下をE2E実装に組み込む（プロダクトに合わせてClaudeが判断）。

- **書き込み系リクエストをブロック**（探索モード中のみ）  
  - 例：`POST/PUT/PATCH/DELETE` を `route.abort()`  
  - ただし、ログイン等に必要なら許可リストで通す
- 外部ドメイン遷移をブロック（同一オリジン以外は abort）
- ステージング用の **テストアカウント**を使う（権限を最小に）
- `storageState` を使ってログイン状態を固定し、探索のブレを減らす

> 注：ブロックするとUI側がエラーを出す場合があるため、探索モードの目的（副作用回避）と、通常E2E（本来の成功導線）を分ける。

### 4.5 賢い探索の実装指針（Claudeがテスト生成するときの約束）
- セレクタは `getByRole()` / `getByLabel()` / `getByText()` を優先（CSS直指定は最後）
- クリック前に必ず：
  - `visible` / `enabled` / `stable`（重なりがないか）を確認
  - `trial` クリック（可能なら）で「クリック可能性」だけ確認
- クリック後に必ず：
  - URL変化 or DOM変化（見出し/主要領域）を確認
  - 直後の Console/pageerror を確認
  - Network 4xx/5xx を確認
- UI被り（z-index）やクリック阻害が疑われる場合：
  - 要素のバウンディングボックスと、クリック座標のヒットテストを使って診断（可能な範囲で）
  - DevToolsで `pointer-events` / overlay を確認

---

## 5. DevTools MCP（失敗時の原因回収のやり方）
E2Eが失敗、または探索で異常を検知したら、必ずDevTools MCPで根拠を取る。

### 5.1 収集するもの（最低限）
- Console のエラー全文（スタックトレース含む）
- Network 失敗リクエスト（URL / ステータス / レスポンス概要 / CORSなど）
- 該当要素のDOM/CSS（表示崩れ or クリック阻害の根拠）
- 可能なら Performance / Layout Shift の兆候（重い・ガタつく等）

### 5.2 レポート形式（必須）
- **症状**：何が起きたか（例：ボタンがクリックできない）
- **再現手順**：E2Eステップ or 操作手順
- **観測**：Console/Network/DOMの根拠
- **原因仮説**：最も可能性が高い順に2〜3個
- **修正案**：最小修正→根本修正の順に提示
- **再テスト結果**：修正後に同じE2Eが通ったこと

---

## 6. テスト生成ポリシー（プロダクトごとにClaudeが作る）
Claudeはプロダクトに合わせて、最低限以下のテストを作成する：

1. **Smoke（健全性）**
   - トップが開く
   - bodyが表示される
   - Console/pageerror が0
   - Networkの4xx/5xxが0（または許可リスト明記）

2. **主要導線（1〜3本）**
   - ユーザー価値の中心（例：作成→保存→表示、検索→詳細、購入フローの手前まで 等）
   - クリック・入力を含む
   - “期待結果” を assert する（表示文言、URL、状態など）

3. **安全探索（副作用最小）**
   - Low/Medium のクリックで “死んでるUI” を検出
   - 破壊的操作は避ける
   - 異常時は証拠（スクショ/トレース/ログ）を残す

4. **視覚（任意だが推奨）**
   - 主要1〜3ページでスクショ差分

---

## 7. 完了報告テンプレ（この形式で出す）
### ✅ 実行コマンド
- build: `...`
- lint: `...`
- e2e: `...`

### ✅ E2E結果
- パス：`...`
- スキップ：`...`
- 失敗：`...`（あれば原因と修正コミット）

### ✅ ランタイム健全性
- Console error: `0`（または件数＋代表例）
- pageerror: `0`（または件数＋代表例）
- Network 4xx/5xx: `0`（または許可リスト＋根拠）

### ✅ UI（スクショ差分）
- 対象：`...`
- 結果：`差分なし / 許容範囲 / 差分あり（修正済）`

### ✅ 重大な発見と対応
- 発見1：症状→根拠→原因→修正
- 発見2：…

### ✅ 添付（生成物）
- Playwright report / trace / screenshots / videos の場所 or アーティファクト情報

---

## 8. 重要な禁止事項
- **証拠なしで「完了」と言わない**
- **破壊的操作（保存/送信/削除/購入 等）を探索モードで勝手に実行しない**
- **Console/Networkの異常を無視して完了にしない**
- **E2Eを通さずに完了にしない**

---

## 9. 使い方メモ（運用のコツ）
- 探索モードは「副作用ブロック」してでも良い（目的が検知だから）。
- 主要導線E2Eは「本当に成功する」ことを確認する（ブロックしない）。
- UI乱れはスクショ差分が最強。最低1ページだけでも導入すると効く。
- 失敗時は DevTools MCP で「根拠」を取ってから直す（推測で直さない）。
